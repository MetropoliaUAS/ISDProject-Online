!function(e,t,n){"use strict";function i(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),i=n.exec(t);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null}function s(){this.products=[],this.genericSensorsRepo=new d,this.selection=new r,this.vue=this.createVue(),this.chart=null}function r(){this.selectedSensorId=null,this.selectedProductId=null,this.selectedGenericSensorId=null,this.timeFilter="hour"}function o(t){var n=this;this.id=t.id,this.sensors=[],e.each(t.sensors,function(e,t){n.sensors.push(new c(t))})}function c(e){this.id=e.id,this.generic_sensor_id=e.generic_sensor_id,this.generic_sensor=dashboard.genericSensorsRepo.findOrCreateFromRaw(e.generic_sensor)}function a(e){this.id=e.id,this.unit=e.unit,this.alias=e.alias,this.symbol=e.symbol,this.unit=e.unit,this.range={low:e.range.split("-")[0],high:e.range.split("-")[1]}}function d(){this.genericSensors={}}function u(){var e={fullWidth:!0,height:500,showArea:!1,showPoint:!1,chartPadding:{right:40},axisX:{showGrid:!1,offset:70},axisY:{offset:70}};this.chart=new n.Line("#chart",null,e)}function h(t){var n=this;n.labels=[],n.serie=[],e.each(t,function(e,t){n.labels.push(t.created_at),n.serie.push(t.sampled)})}s.prototype.createVue=function(){var n=this;return new t({el:"#dashboard-wrapper",data:{products:n.products,selection:n.selection},methods:{onSensorClick:function(e){dashboard.selection.selectSensor(e)},onTimeFilterClick:function(t){dashboard.selection.selectTimeFilter(e(t.target).data("time-filter"))},genericSensorAlias:function(e){var t=dashboard.genericSensorsRepo.find(e);return t?t.alias:""}}})},s.prototype.run=function(){var t,n=this,s=window.location.origin+"/api/products";e.getJSON(s,null,function(s){e.each(s,function(e,t){n.products.push(new o(t))}),t=parseInt(i("sensor")),t&&n.selection.selectSensor(t)}),this.chart=new u},s.prototype.findSensor=function(t){var n=null;return e.each(this.products,function(i,s){return e.each(s.sensors,function(e,i){return i.id===t?(n=i,!1):void 0}),n?!1:void 0}),n},s.prototype.productIdBySensor=function(t){var n=null,i=t.id||t;return e.each(this.products,function(t,s){return e.each(s.sensors,function(e,t){return t.id===i?(n=s,!1):void 0}),n?!1:void 0}),n},s.prototype.getNewSamples=function(){var t,n,i=this;t=window.location.origin+"/api/samplings/show/"+i.selection.selectedProductId,n={generic_sensor_id:this.selection.selectedGenericSensorId,timeFilter:i.selection.timeFilter},n.generic_sensor_id&&e.getJSON(t,n,function(e){i.chart.update(new h(e))})},s.prototype.sensorSelectionChange=function(){this.getNewSamples()},s.prototype.timeFilterSelectionChange=function(){this.getNewSamples()},r.prototype.selectSensor=function(e){(e instanceof Object||(e=dashboard.findSensor(e)))&&(this.selectedSensorId=e.id,this.selectedGenericSensorId=e.generic_sensor_id,this.selectedProductId=dashboard.productIdBySensor(e).id,dashboard.sensorSelectionChange())},r.prototype.selectTimeFilter=function(e){this.timeFilter=e,dashboard.timeFilterSelectionChange()},d.prototype.findOrCreateFromRaw=function(e){if(this.genericSensors[e.id])return this.genericSensors[e.id];var t=new a(e);return this.genericSensors[t.id]=t,t},d.prototype.find=function(e){return this.genericSensors[e]},u.prototype.buildNewOpts=function(){var e;return e=dashboard.genericSensorsRepo.find(dashboard.selection.selectedGenericSensorId).unit,{axisX:{labelInterpolationFnc:function(e,t,n){var i=Math.round(n.length/15);return 0==i?e:t%i===0?e:""}},axisY:{labelInterpolationFnc:function(t){return t+" "+e}}}},u.prototype.update=function(e){var t=e.getData(),n=this.buildNewOpts();1==e.count()&&(t=this.fixNewData(t)),this.chart.update(t,n,!0)},u.prototype.fixNewData=function(e){return e.labels.push(e.labels[0]),e.series[0].push(e.series[0][0]),e},h.prototype.getData=function(){return{labels:this.labels,series:[this.serie]}},h.prototype.count=function(){return this.serie.length},e(document).on("ready",function(){window.dashboard=new s,dashboard.run()})}(jQuery,Vue,Chartist);